---
description: WordPress and PHP 7.4+ development standards for plugins, themes, hooks, security, performance, and WordPress coding standards
globs: *.php, functions.php, style.css, *.theme, composer.json, wp-config.php
alwaysApply: false
tags:
  - language:php
  - framework:wordpress
  - category:best-practice
  - category:security
  - category:performance
---
# WordPress & PHP Development Standards

Enforces WordPress and PHP 7.4+ development best practices, including plugin/theme development, WordPress APIs, hooks, security, performance, and coding standards.

<rule>
name: wordpress_php_standards
description: Enforce WordPress and PHP 7.4+ development best practices for plugins, themes, and customizations
filters:
  - type: file_extension
    pattern: "\\.php$"
  - type: file_path
    pattern: ".*(wp-content|plugins|themes|functions|inc|includes).*"

actions:
  - type: enforce
    conditions:
      # PHP Version & Type Safety
      - pattern: "^<\\?php(?!.*declare\\(strict_types=1\\))"
        message: "Use declare(strict_types=1) at the top of PHP files for type safety."
      
      - pattern: "function\\s+\\w+\\([^)]*\\)(?!.*:)"
        message: "All functions should have explicit return type declarations. Use : void, : string, : array, etc."
      
      # WordPress Security
      - pattern: "\\$_GET\\[|\\$_POST\\[|\\$_REQUEST\\["
        message: "Never use superglobals directly. Use WordPress sanitization functions: sanitize_text_field(), sanitize_email(), wp_verify_nonce(), etc."
      
      - pattern: "echo\\s+\\$|print\\s+\\$"
        message: "Always escape output. Use esc_html(), esc_attr(), esc_url(), wp_kses_post(), or wp_kses() before echoing variables."
      
      - pattern: "\\$wpdb->query\\([^)]*\\$|\\$wpdb->prepare\\([^)]*\\)(?!.*%s|.*%d)"
        message: "Always use $wpdb->prepare() for SQL queries with placeholders (%s, %d, %f) to prevent SQL injection."
      
      # WordPress Hooks
      - pattern: "add_action\\(|add_filter\\(|do_action\\(|apply_filters\\("
        message: "Ensure hook names follow WordPress naming conventions: use prefixes (plugin/theme slug) and descriptive names."
      
      # Nonce Verification
      - pattern: "wp_nonce_field\\(|wp_create_nonce\\("
        message: "Always verify nonces with wp_verify_nonce() before processing form submissions or AJAX requests."
      
      # Capability Checks
      - pattern: "current_user_can\\(|user_can\\(|is_user_logged_in\\(\\)"
        message: "Always check user capabilities before performing privileged operations. Use current_user_can() with specific capabilities."
      
      # Database Operations
      - pattern: "\\$wpdb->(insert|update|delete|replace)\\([^)]*\\)(?!.*prepare)"
        message: "Use $wpdb->prepare() for all database operations with user input. Never concatenate variables into SQL queries."
      
      # Asset Enqueuing
      - pattern: "<link|<script|<style"
        message: "Never hardcode CSS/JS in templates. Use wp_enqueue_style() and wp_enqueue_script() in proper hooks (wp_enqueue_scripts)."
      
      # Direct File Access
      - pattern: "include\\s+|require\\s+|include_once|require_once"
        message: "Use WordPress file loading functions when appropriate. Ensure ABSPATH is defined before including files."

  - type: suggest
    message: |
      **WordPress & PHP Development Best Practices:**
      
      ### PHP 7.4+ Features
      ```php
      <?php
      declare(strict_types=1);
      
      namespace MyPlugin;
      
      // ✅ Good - Typed properties and return types
      class MyPlugin {
          private string $plugin_name;
          private string $version;
          
          public function __construct(string $plugin_name, string $version) {
              $this->plugin_name = $plugin_name;
              $this->version = $version;
          }
          
          public function get_plugin_name(): string {
              return $this->plugin_name;
          }
          
          // ✅ Good - Arrow functions for simple closures
          public function register_hooks(): void {
              add_action('init', fn() => $this->init());
          }
      }
      ```
      
      ### Security - Input Sanitization
      ```php
      // ✅ Good - Sanitize all user input
      $user_input = sanitize_text_field($_POST['user_name'] ?? '');
      $user_email = sanitize_email($_POST['user_email'] ?? '');
      $user_url = esc_url_raw($_POST['user_url'] ?? '');
      
      // ✅ Good - Validate and sanitize
      if (!is_email($user_email)) {
          wp_die('Invalid email address');
      }
      ```
      
      ### Security - Output Escaping
      ```php
      // ✅ Good - Escape all output
      <h1><?php echo esc_html($title); ?></h1>
      <a href="<?php echo esc_url($link); ?>"><?php echo esc_html($link_text); ?></a>
      <div><?php echo wp_kses_post($content); ?></div>
      
      // ✅ Good - For attributes
      <input type="text" value="<?php echo esc_attr($value); ?>" />
      ```
      
      ### Security - Nonce Verification
      ```php
      // ✅ Good - Create nonce in form
      wp_nonce_field('my_action', 'my_nonce_field');
      
      // ✅ Good - Verify nonce on submission
      public function handle_form_submission(): void {
          if (!isset($_POST['my_nonce_field']) || 
              !wp_verify_nonce($_POST['my_nonce_field'], 'my_action')) {
              wp_die('Security check failed');
          }
          
          // Process form
          $data = sanitize_text_field($_POST['data'] ?? '');
          // ...
      }
      ```
      
      ### Security - Capability Checks
      ```php
      // ✅ Good - Check capabilities
      if (!current_user_can('manage_options')) {
          wp_die('You do not have permission to access this page.');
      }
      
      // ✅ Good - Check for specific capabilities
      if (!current_user_can('edit_post', $post_id)) {
          return;
      }
      ```
      
      ### Database Operations
      ```php
      global $wpdb;
      
      // ✅ Good - Prepared statements
      $results = $wpdb->get_results(
          $wpdb->prepare(
              "SELECT * FROM {$wpdb->prefix}my_table WHERE user_id = %d AND status = %s",
              $user_id,
              $status
          )
      );
      
      // ✅ Good - Insert with prepare
      $wpdb->insert(
          $wpdb->prefix . 'my_table',
          [
              'user_id' => $user_id,
              'data' => sanitize_text_field($data),
              'created_at' => current_time('mysql'),
          ],
          ['%d', '%s', '%s']
      );
      ```
      
      ### WordPress Hooks & Filters
      ```php
      // ✅ Good - Use hooks with proper prefixes
      add_action('init', [$this, 'init']);
      add_filter('the_content', [$this, 'filter_content'], 10, 1);
      add_action('wp_enqueue_scripts', [$this, 'enqueue_assets']);
      
      // ✅ Good - Remove hooks when needed
      remove_action('wp_head', 'wp_generator');
      
      // ✅ Good - Custom hooks
      do_action('myplugin_before_content', $post_id);
      $content = apply_filters('myplugin_content', $content, $post_id);
      ```
      
      ### Asset Management
      ```php
      // ✅ Good - Enqueue scripts and styles
      public function enqueue_assets(): void {
          wp_enqueue_style(
              'myplugin-style',
              plugin_dir_url(__FILE__) . 'assets/css/style.css',
              [],
              $this->version
          );
          
          wp_enqueue_script(
              'myplugin-script',
              plugin_dir_url(__FILE__) . 'assets/js/script.js',
              ['jquery'],
              $this->version,
              true
          );
          
          // ✅ Good - Localize script for AJAX
          wp_localize_script(
              'myplugin-script',
              'mypluginData',
              [
                  'ajax_url' => admin_url('admin-ajax.php'),
                  'nonce' => wp_create_nonce('myplugin_nonce'),
              ]
          );
      }
      ```
      
      ### AJAX Handling
      ```php
      // ✅ Good - AJAX with nonce verification
      add_action('wp_ajax_my_action', [$this, 'handle_ajax']);
      add_action('wp_ajax_nopriv_my_action', [$this, 'handle_ajax']);
      
      public function handle_ajax(): void {
          check_ajax_referer('myplugin_nonce', 'nonce');
          
          if (!current_user_can('manage_options')) {
              wp_send_json_error(['message' => 'Unauthorized']);
              return;
          }
          
          $data = sanitize_text_field($_POST['data'] ?? '');
          wp_send_json_success(['result' => $data]);
      }
      ```
      
      ### Transients & Caching
      ```php
      // ✅ Good - Use transients for caching
      $cache_key = 'myplugin_data_' . $user_id;
      $data = get_transient($cache_key);
      
      if (false === $data) {
          $data = $this->fetch_expensive_data($user_id);
          set_transient($cache_key, $data, HOUR_IN_SECONDS);
      }
      
      // ✅ Good - Delete transients when needed
      delete_transient($cache_key);
      ```
      
      ### WP_Query Best Practices
      ```php
      // ✅ Good - Proper WP_Query usage
      $args = [
          'post_type' => 'my_post_type',
          'posts_per_page' => 10,
          'post_status' => 'publish',
          'meta_query' => [
              [
                  'key' => 'my_meta_key',
                  'value' => $value,
                  'compare' => '=',
              ],
          ],
      ];
      
      $query = new WP_Query($args);
      
      if ($query->have_posts()) {
          while ($query->have_posts()) {
              $query->the_post();
              // Output post
          }
          wp_reset_postdata();
      }
      ```
      
      ### Error Handling & Logging
      ```php
      // ✅ Good - Error handling with logging
      try {
          $result = $this->risky_operation();
      } catch (Exception $e) {
          if (defined('WP_DEBUG') && WP_DEBUG) {
              error_log('MyPlugin Error: ' . $e->getMessage());
          }
          // Handle error gracefully
          return false;
      }
      
      // ✅ Good - Use WordPress debug functions
      if (defined('WP_DEBUG_LOG') && WP_DEBUG_LOG) {
          error_log('MyPlugin: ' . print_r($data, true));
      }
      ```
      
      ### Internationalization
      ```php
      // ✅ Good - Make strings translatable
      __('Hello World', 'my-plugin');
      _e('Hello World', 'my-plugin');
      esc_html__('Hello World', 'my-plugin');
      esc_html_e('Hello World', 'my-plugin');
      
      // ✅ Good - Plural forms
      printf(
          _n('%d item', '%d items', $count, 'my-plugin'),
          $count
      );
      
      // ✅ Good - Context
      _x('Post', 'verb', 'my-plugin');
      ```
      
      ### Plugin Structure
      ```php
      <?php
      /**
       * Plugin Name: My Plugin
       * Plugin URI: https://example.com/my-plugin
       * Description: Plugin description
       * Version: 1.0.0
       * Author: Your Name
       * Author URI: https://example.com
       * License: GPL-2.0+
       * Text Domain: my-plugin
       * Domain Path: /languages
       */
      
      // ✅ Good - Prevent direct access
      if (!defined('ABSPATH')) {
          exit;
      }
      
      // ✅ Good - Define plugin constants
      define('MY_PLUGIN_VERSION', '1.0.0');
      define('MY_PLUGIN_PATH', plugin_dir_path(__FILE__));
      define('MY_PLUGIN_URL', plugin_dir_url(__FILE__));
      
      // ✅ Good - Autoloader or require files
      require_once MY_PLUGIN_PATH . 'includes/class-my-plugin.php';
      
      // ✅ Good - Initialize plugin
      function my_plugin_init() {
          $plugin = new My_Plugin();
          $plugin->run();
      }
      add_action('plugins_loaded', 'my_plugin_init');
      ```
      
      ### Performance Optimization
      ```php
      // ✅ Good - Use object caching
      $cache_key = 'my_data_' . md5($identifier);
      $data = wp_cache_get($cache_key);
      
      if (false === $data) {
          $data = expensive_operation();
          wp_cache_set($cache_key, $data, '', 3600);
      }
      
      // ✅ Good - Lazy load assets
      if (is_single() && get_post_type() === 'my_post_type') {
          wp_enqueue_script('my-script');
      }
      ```
      
      ### Database Schema Changes
      ```php
      // ✅ Good - Use dbDelta for schema changes
      function my_plugin_create_table(): void {
          global $wpdb;
          
          $table_name = $wpdb->prefix . 'my_table';
          $charset_collate = $wpdb->get_charset_collate();
          
          $sql = "CREATE TABLE $table_name (
              id bigint(20) NOT NULL AUTO_INCREMENT,
              user_id bigint(20) NOT NULL,
              data text NOT NULL,
              created_at datetime DEFAULT CURRENT_TIMESTAMP,
              PRIMARY KEY  (id),
              KEY user_id (user_id)
          ) $charset_collate;";
          
          require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
          dbDelta($sql);
      }
      
      register_activation_hook(__FILE__, 'my_plugin_create_table');
      ```

metadata:
  priority: high
  version: 1.0
</rule>
