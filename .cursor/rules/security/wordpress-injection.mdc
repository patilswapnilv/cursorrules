---
description: Detect and prevent injection vulnerabilities in WordPress as defined in OWASP Top 10:2021-A03
globs: *.php, functions.php
alwaysApply: false
---
# WordPress Injection Security Standards (OWASP A03:2021)

This rule enforces security best practices to prevent injection vulnerabilities in WordPress applications, as defined in OWASP Top 10:2021-A03.

## Rule Details

- **Name:** wordpress_injection

- **Description:** Detect and prevent injection vulnerabilities in WordPress as defined in OWASP Top 10:2021-A03

## Filters
- file extension pattern: `\.(php)$`
- file path pattern: `.*(wp-content|plugins|themes|functions).*`

## Enforcement Checks
- Conditions:
  - pattern `\$wpdb->query\(['"][^'"]*\$[^'"]*['"]` – Direct variables in SQL queries are vulnerable to SQL injection. Use $wpdb->prepare() with placeholders.
    - Pattern 1: Raw SQL queries without placeholders
  - pattern `\$wpdb->(insert|update|delete|replace)\([^)]*\)(?!.*prepare)` – Use $wpdb->prepare() for all database operations with user input to prevent SQL injection.
    - Pattern 2: Database operations without prepare
  - pattern `echo\s+\$|print\s+\$|<\?=\s*\$` – Direct output may lead to XSS. Use esc_html(), esc_attr(), esc_url(), wp_kses_post(), or wp_kses() before outputting variables.
    - Pattern 3: Unescaped output
  - pattern `\$content\s*=.*\$_(GET|POST|REQUEST|COOKIE|SERVER|FILES)` – Never use unfiltered user input directly. Sanitize with sanitize_text_field(), sanitize_email(), etc.
    - Pattern 4: Unfiltered user input
  - pattern `wp_localize_script\([^,]+,\s*[^,]+,\s*\[(?![^\]]*(esc_|sanitize_))\$` – Filter variables before adding to JavaScript using esc_js() or wp_json_encode().
    - Pattern 5: Unescaped variables in JavaScript
  - pattern `exec\(|shell_exec\(|system\(|passthru\(|proc_open\(|popen\(|``` – Command execution functions can lead to command injection. Avoid or use with extreme caution and proper validation.
    - Pattern 6: Direct command execution
  - pattern `wp_redirect\([^,]*\$(?!(this->|allowed_destinations|home_url|site_url))` – Unvalidated redirects can lead to open redirect vulnerabilities. Whitelist allowed destinations.
    - Pattern 7: Unvalidated redirect
  - pattern `\$wpdb->(get_var|get_row|get_results)\(['"][^'"]*\$[^'"]*['"]` – Use $wpdb->prepare() before using variables in database queries to prevent SQL injection.
    - Pattern 8: Raw user input in database queries
  - pattern `add_action\(['"]wp_ajax|add_action\(['"]wp_ajax_nopriv` – AJAX handlers must include nonce verification with wp_verify_nonce() to prevent CSRF attacks.
    - Pattern 9: Missing CSRF protection in AJAX
  - pattern `file_get_contents\(\s*\$(?!(this->|allowed_paths|WP_CONTENT_DIR|ABSPATH))` – Validate file paths before operations to prevent path traversal attacks.
    - Pattern 10: Unvalidated file operations

## Suggestions
- Guidance:
**WordPress Injection Prevention Best Practices:**

1. **SQL Injection Prevention:**
   - Always use $wpdb->prepare() with placeholders (%s, %d, %f)
   - Use WordPress database functions: wp_insert_post(), wp_update_post(), etc.
   - Properly escape table and field names
   - Consider using WP_Query for post queries instead of raw SQL

2. **XSS Prevention:**
   - Always escape output: esc_html(), esc_attr(), esc_url(), esc_js()
   - Use wp_kses_post() or wp_kses() for HTML content
   - Sanitize input: sanitize_text_field(), sanitize_email(), sanitize_textarea_field()
   - Use wp_nonce_field() and wp_verify_nonce() for forms
   - Never trust user input

3. **CSRF Protection:**
   - Always include nonces with wp_nonce_field() in forms
   - Verify nonces with wp_verify_nonce() or check_admin_referer()
   - For AJAX requests, include nonce in data and verify server-side
   - Use wp_create_nonce() for custom nonce generation

4. **Command Injection Prevention:**
   - Avoid command execution functions entirely
   - If necessary, use escapeshellarg() and escapeshellcmd()
   - Validate and whitelist any input used in command contexts
   - Consider using WordPress functions instead of system commands

5. **Path Traversal Prevention:**
   - Validate file paths with realpath() and path validation
   - Use WordPress constants: WP_CONTENT_DIR, ABSPATH, etc.
   - Implement strict input validation for any path components
   - Use wp_upload_dir() for file uploads

## Validation Checks
- Conditions:
  - pattern `\$wpdb->prepare\(['"][^'"]*%[sdf][^'"]*['"],\s*\[[^\]]*\]\)` – Properly using prepared statements with placeholders.
    - Check 1: Proper SQL query usage
  - pattern `(esc_html|esc_attr|esc_url|esc_js|wp_kses_post|wp_kses)\(` – Using proper XSS prevention techniques.
    - Check 2: Proper XSS prevention
  - pattern `wp_verify_nonce\(|check_admin_referer\(|wp_nonce_field\(` – Implementing CSRF protection correctly.
    - Check 3: Proper CSRF protection
  - pattern `sanitize_text_field\(|sanitize_email\(|sanitize_textarea_field\(` – Using proper input sanitization.
    - Check 4: Proper input sanitization

## Metadata
- Priority: high
- Version: 1.1
- Tags: security, wordpress, injection, sql, xss, csrf, owasp, language:php, framework:wordpress, category:security, subcategory:injection, standard:owasp-top10, risk:a03-injection
## References
- https://owasp.org/Top10/A03_2021-Injection/
- https://developer.wordpress.org/plugins/security/data-validation/
- https://developer.wordpress.org/plugins/security/securing-output/
- https://developer.wordpress.org/reference/classes/wpdb/prepare/
