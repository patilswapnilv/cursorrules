---
description: Detect and prevent cryptographic failures in WordPress as defined in OWASP Top 10:2021-A02
globs: *.php, wp-config.php
alwaysApply: false
---
# WordPress Cryptographic Failures Security Standards (OWASP A02:2021)

This rule enforces security best practices to prevent cryptographic failures in WordPress applications, as defined in OWASP Top 10:2021-A02.

## Rule Details

- **Name:** wordpress_cryptographic_failures

- **Description:** Detect and prevent cryptographic failures in WordPress as defined in OWASP Top 10:2021-A02

## Filters
- file extension pattern: `\.(php)$`
- file path pattern: `.*(wp-content|plugins|themes|wp-config).*`

## Enforcement Checks
- Conditions:
  - pattern `(md5|sha1)\([^)]*\)` – Weak hash algorithm detected. Use password_hash() for passwords or hash('sha256'/'sha512') for other data.
    - Pattern 1: Use of weak hash algorithms
  - pattern `(password|key|token|secret|credentials|pwd)\s*=\s*['"][^'"]+['"]` – Hardcoded credentials or sensitive keys detected. Use WordPress constants, environment variables, or wp-config.php with proper security.
    - Pattern 2: Hardcoded credentials or keys
  - pattern `wp_set_password\([^,]+,\s*['"][^'"]+['"]` – Never store plaintext passwords. WordPress handles password hashing internally via wp_hash_password().
    - Pattern 3: Plaintext password storage
  - pattern `file_(get|put)_contents\([^,]+,\s*[^,]+\)` – Consider encrypting sensitive file contents using PHP's openssl functions or WordPress encryption plugins.
    - Pattern 4: Improper file encryption
  - pattern `define\s*\(['"]DB_PASSWORD['"]|define\s*\(['"]AUTH_KEY['"]|define\s*\(['"]SECURE_AUTH_KEY['"]` – Sensitive data in wp-config.php should use environment variables or secure key management.
    - Pattern 5: Unprotected sensitive data in wp-config
  - pattern `(rand|mt_rand|array_rand)\(` – Insecure random number generation. Use random_bytes() or random_int() for cryptographic purposes.
    - Pattern 6: Insecure random number generation
  - pattern `FORCE_SSL_ADMIN|is_ssl\(\)` – Ensure HTTPS is enforced for admin area and sensitive pages containing sensitive information.
    - Pattern 7: Missing HTTPS enforcement
  - pattern `update_user_meta\(|add_user_meta\(|update_post_meta\(` – Consider using field encryption for sensitive user/post meta data (passwords, tokens, keys).
    - Pattern 8: Missing encryption for sensitive metadata
  - pattern `session_(start|regenerate_id)` – Avoid custom session handling. Use WordPress's authentication system.
    - Pattern 9: Custom session handling without proper security
  - pattern `\$token\s*=\s*.*?\$[^;]+;(?![^;]*expir|[^;]*valid)` – API tokens should include expiration time or rotation mechanism.
    - Pattern 10: API tokens without expiration or rotation

## Suggestions
- Guidance:
**WordPress Cryptographic Security Best Practices:**

1. **Secure Data Storage:**
   - Use WordPress's built-in password hashing (wp_hash_password())
   - Store sensitive configuration in wp-config.php with proper file permissions (600)
   - Use environment variables for production credentials
   - Never store plaintext sensitive information in the database
   - Consider using encryption plugins for sensitive data

2. **Encryption and Hashing:**
   - Use WordPress's password hashing system, which uses password_hash() internally
   - For non-password data hashing, use SHA-256 or SHA-512
   - Use PHP's openssl_encrypt() with proper algorithms (AES-256-GCM)
   - Always use proper salting techniques
   - Use wp_salt() for generating secure salts

3. **Communication Security:**
   - Enforce HTTPS site-wide using FORCE_SSL_ADMIN in wp-config.php
   - Use secure cookies (secure, HttpOnly, SameSite)
   - Implement proper Content-Security-Policy headers
   - Use TLS 1.2+ for all connections
   - Configure SECURE_AUTH_COOKIE and LOGGED_IN_COOKIE securely

4. **API Security:**
   - Use OAuth or JWT with proper signature verification
   - Implement token expiration and rotation
   - Use HMAC for API request signatures when appropriate
   - Never expose internal encryption keys through APIs
   - Use Application Passwords for REST API authentication

5. **Configuration Best Practices:**
   - Regularly rotate encryption keys (AUTH_KEY, SECURE_AUTH_KEY, etc.)
   - Use strong, unique keys generated via wp-config.php generator
   - Implement secure key storage using environment variables
   - Monitor and log cryptographic operations
   - Maintain an inventory of cryptographic algorithms in use

## Validation Checks
- Conditions:
  - pattern `wp_hash_password\(|wp_check_password\(|password_hash\(` – Using WordPress's password system correctly.
    - Check 1: Proper password handling
  - pattern `random_bytes|random_int|wp_generate_password\(` – Using secure random generation methods.
    - Check 2: Proper random generation
  - pattern `getenv\(['"]|WP_ENVIRONMENT_TYPE|wp_get_environment_type\(` – Using environment variables correctly.
    - Check 3: Secure settings
  - pattern `openssl_encrypt\(|mcrypt_encrypt\(` – Using proper encryption methods.
    - Check 4: Proper encryption usage

## Metadata
- Priority: high
- Version: 1.1
- Tags: security, wordpress, cryptography, encryption, owasp, language:php, framework:wordpress, category:security, subcategory:cryptography, standard:owasp-top10, risk:a02-cryptographic-failures
## References
- https://owasp.org/Top10/A02_2021-Cryptographic_Failures/
- https://developer.wordpress.org/reference/functions/wp_hash_password/
- https://developer.wordpress.org/reference/functions/wp_salt/
- https://wordpress.org/support/article/editing-wp-config-php/
